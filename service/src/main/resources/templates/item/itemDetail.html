<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/layout/layout">


<th:block layout:fragment="css">
    <link th:href="@{/css/itemDetail.css}" rel="stylesheet">
</th:block>

<th:block layout:fragment="script">
    <script th:inline="javascript" th:src="@{/js/itemDetail.js}"></script>

    <script th:inline="javascript">
        $(document).ready(function () {

            calculateToalPrice();

            $("#orderCount").change(function () {
                calculateToalPrice();
            });
        });

        function calculateToalPrice() {
            let orderCount = $("#orderCount").val();
            let price = $("#price").val();
            let totalPrice = price * orderCount;
            $("#totalPrice").html(totalPrice + '원');
        }

        // function order() {
        //     console.log("order")
        //     let token = $("meta[name='_csrf']").attr("content");
        //     let header = $("meta[name='_csrf_header']").attr("content");
        //
        //     let url = "/order";
        //     let paramData = {
        //         itemId: $("#itemId").val(),
        //         orderCount: $("#orderCount").val()
        //     };
        //
        //     let param = JSON.stringify(paramData);
        //
        //     $.ajax({
        //         url: url,
        //         type: "POST",
        //         contentType: "application/json",
        //         data: param,
        //         beforeSend: function (xhr) {
        //             /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
        //             xhr.setRequestHeader(header, token);
        //         },
        //         dataType: "json",
        //         cache: false,
        //         success: function (result, status) {
        //             alert("주문이 완료 되었습니다.");
        //             location.href = '/';
        //         },
        //         error: function (jqXHR, status, error) {
        //
        //             if (jqXHR.status == '401') {
        //                 alert('로그인 후 이용해주세요');
        //                 location.href = '/members/login';
        //             } else {
        //                 alert(jqXHR.responseText);
        //             }
        //
        //         }
        //     });
        // }

        // function addCart() {
        //     var token = $("meta[name='_csrf']").attr("content");
        //     var header = $("meta[name='_csrf_header']").attr("content");
        //
        //     var url = "/cart";
        //     var paramData = {
        //         itemId: $("#itemId").val(),
        //         itemCount: $("#orderCount").val()
        //     };

        //
        //     var param = JSON.stringify(paramData);
        //
        //     $.ajax({
        //         url: url,
        //         type: "POST",
        //         contentType: "application/json",
        //         data: param,
        //         beforeSend: function (xhr) {
        //             /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
        //             xhr.setRequestHeader(header, token);
        //         },
        //         dataType: "json",
        //         cache: false,
        //         success: function (result, status) {
        //             alert("상품을 장바구니에 담았습니다.");
        //             location.href = '/';
        //         },
        //         error: function (jqXHR, status, error) {
        //
        //             if (jqXHR.status == '401') {
        //                 alert('로그인 후 이용해주세요');
        //                 location.href = '/members/login';
        //             } else {
        //                 alert(jqXHR.responseText);
        //             }
        //
        //         }
        //     });
        // }

    </script>
</th:block>


<div layout:fragment="content">

    <div id="itemDetailContainer" class="itemDetailContainer">
        <input type="hidden" id="itemId" th:value="${item.id}">

        <div id="BuyBox" class="d-flex">
            <div class="repImgDiv" >
                <img th:each="itemImg : ${item.itemImageDtos}" th:if="${itemImg.representativeImageYn.equals('Y')}" id="itemDetailMainImg" th:src="${itemImg.imageUrl}"
                     class="rounded repImg "
                     th:alt="${itemImg.getUniqueName}">
            </div>
            <div class="wd50">
                <div class="SellStatus_ItemName">
            <span id="Selling"
                  th:if="${item.itemStatus eq T(com.petkpetk.service.domain.shopping.constant.ItemStatus).SELL}"
                  class="badge badge-primary mgb-15 statusClass">
            </span>
                    <span id="SoldOut"
                          th:unless="${item.itemStatus eq T(com.petkpetk.service.domain.shopping.constant.ItemStatus).SELL}"
                          class="badge btn-danger mgb-15 statusClass">
                품절
            </span>
                    <div id="SellingName" class="itemDetailName" th:text="${item.itemName}"
                         th:if="${item.itemStatus eq T(com.petkpetk.service.domain.shopping.constant.ItemStatus).SELL}"></div>
                    <div id="SoldOutName" class="itemDetailName" th:text="${item.itemName}"
                         th:unless="${item.itemStatus eq T(com.petkpetk.service.domain.shopping.constant.ItemStatus).SELL}"></div>
                </div>

                <div class="chooseProduct">
                    <div class="h4 text-danger text-left cost">
                        <input type="hidden" th:value="${item.price}" id="price" name="price">
                        <span class="OriginalCost">888원</span><span id="cost"
                                                                    th:text="${item.price}"></span>
                    </div>
                    <div class="input-group w-50 ChooseAmountBox">
                        <div class="totalflexBox">
                            <span class="chong">총</span>
                            <div id="totalPrice" class="input-group-prepend "
                                 th:text="${item.price}">
                            </div>
                            <span class="totalWon"> 원</span>
                        </div>
                        <div class="addBtn">
                            <input type="button" id="minusAmount" value="◀" onclick="minusCount()">
                            <input type="text" name="orderCount" id="orderCount"
                                   class="form-control" value="1" min="1"
                                   readonly>
                            <input type="button" id="plusAmount" value="▶" onclick="plusCount()">
                        </div>

                    </div>
                </div>
                <hr class="my-4">


                <div th:if="${item.itemStatus eq T(com.petkpetk.service.domain.shopping.constant.ItemStatus).SELL}"
                     class="text-right lastOrderTurn">
                    <button type="button" class="btn btn-light border border-primary btn-lg getCart"
                            onclick="addCart()">
                        장바구니 담기
                    </button>
                    <button type="button" class="btn btn-primary btn-lg getOrder" onclick="order()">
                        주문하기
                    </button>
                </div>

                <div th:unless="${item.itemStatus eq T(com.petkpetk.service.domain.shopping.constant.ItemStatus).SELL}"
                     class="text-right lastOrderTurn">
                    <button type="button" class="btn btn-light border border-primary btn-lg getCart"
                            disabled="disabled">
                        장바구니 담기
                    </button>
                    <button type="button" class="btn btn-primary btn-lg getOrder"
                            disabled="disabled">주문하기
                    </button>
                </div>
            </div>

        </div>

        <div class="jumbotron jumbotron-fluid mgt-30">
            <div class="EXDiv">
                <div class="chooseBtn">
                    <div id="detailBtn" class="explainDiv" onclick="showDetailBoxs(this)">상품 상세
                    </div>
                    <div id="reviewBtn" class="explainDiv" onclick="showDetailBoxs(this)">리뷰</div>
                    <div id="businessBtn" class="explainDiv" onclick="showDetailBoxs(this)">사업 정보
                    </div>
                </div>
                <div id="detailBox" class="lead">
                    <div th:text="${item.itemDetail}" style="margin-bottom: 40px"></div>
                    <div th:each="itemImg : ${item.itemImageDtos}" class="text-center imgCenter">
                        <img th:if="${itemImg.representativeImageYn.equals('Y')}"
                             th:src="${itemImg.imageUrl}" class="rounded mgb-15"
                             width="800">
                        <img th:if="${!itemImg.representativeImageYn.equals('Y')}"
                             th:src="${itemImg.imageUrl}" class="rounded mgb-15"
                             width="800">
                    </div>
                </div>

                <div id="reviewBox" class="lead">
                    <div class="reviewOneBox" th:if="${!reviewList.isEmpty()}"
                         th:each="review, status : ${reviewList}">
                        <div class="reviewOneBox_nickName_time">
                            <div class="ReviewFlex">
                                <div class="userReviewProfile">
                                    <img class="reviewProfile" th:src="@{/images/icon.png}">
                                </div>
                                <div class="titleBox">
                                    <div class="userNickName"
                                         th:text="${review.userAccount.nickname}"></div>
                                    <span class="likeTitle">도움이 됐어요</span>
                                    <div class="reviewLikes" th:id="'reviewLikes'+${review.getId()}"
                                         th:text="${review.getLikes()}"></div>
                                </div>
                                <input id="userEmail" type="hidden" th:value="${userEmail}">
                                <input th:id="'likeCount'+${review.getId()}" type="hidden"
                                       th:value="${review.getLikes()}">
                                <div th:unless="${reviewHashMap == null}">
                                    <img th:if="${reviewHashMap.get('review'+review.getId()) == null}"
                                         sec:authorize="hasAnyAuthority('ROLE_USER')" class="likes"
                                         th:id="'likes' + ${review.getId()}"
                                         th:src="@{/images/likesBefore.png}"
                                         th:onmouseover="'likesMouseOn('+${review.getId()}+'); intoLikeOnclick('+${review.getId()}+')'"
                                         th:onmouseout="'likesMouseOn('+${review.getId()}+')'">
                                    <img th:unless="${reviewHashMap.get('review'+review.getId()) == null}"
                                         sec:authorize="hasAnyAuthority('ROLE_USER')" class="likes"
                                         th:id="'likes' + ${review.getId()}"
                                         th:src="@{/images/likesAfter.png}"
                                         th:onmouseover="'intoLikeOnclick('+${review.getId()}+')'">
                                </div>
                                <div th:if="${reviewHashMap == null}">
                                    <img sec:authorize="hasAnyAuthority('ROLE_USER')" class="likes"
                                         th:id="'likes' + ${review.getId()}"
                                         th:src="@{/images/likesBefore.png}"
                                         th:onmouseover="'likesMouseOn('+${review.getId()}+'); intoLikeOnclick('+${review.getId()}+')'"
                                         th:onmouseout="'likesMouseOn('+${review.getId()}+')'">
                                </div>
                            </div>

                            <div>
                                <form class="btnFlex"
                                      th:action="@{'/review/delete/'+${item.id}+'/'+${review.getId()}}"
                                      method="post"
                                      th:if="${review.userAccount.email.equals(userEmail)}">
                                    <input class="delete reviewBtn" type="submit" value="삭제">
                                    <input class="modify reviewBtn" type="button" value="수정"
                                           th:onclick="'showReviewModal('+${review.getId()}+', '+${item.id}+')'">
                                </form>
                            </div>
                        </div>
                        <pre><div th:id="'reviewContent'+${review.getId()}" class="reviewContent" th:text="${review.content}"></div></pre>
                    </div>
                    <div class="nonReview" th:if="${reviewList.isEmpty()}">
                        등록 된 리뷰가 없습니다.
                    </div>

                </div>
                <div id="businessBox" class="lead">
                    사업정보
                </div>
            </div>
        </div>
    </div>
    <form method="post" id="reviewModalForm" style="display: none;">
        <div id="reviewModal">
            <div class="reviewModifyBtn">
                <input id="cancelModify" class="cancelModify modiBtn" type="button" value="취소">
                <input class="completeModify modiBtn" type="submit" value="완료">
            </div>
            <div>
                <pre><textarea id="reviewModalContent" name="newReviewContent"></textarea></pre>
            </div>
        </div>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    </form>
</div>


</html>